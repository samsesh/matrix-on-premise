version: '3'
services:
  coturn:
    image: instrumentisto/coturn:latest
    restart: unless-stopped
    volumes:
      - ./coturn/turnserver.conf:/etc/coturn/turnserver.conf
    ports:
      - "49160-49200:49160-49200/udp"
      - "3478:3478"
      - "3478:3478/udp"
      - "5349:5349"
      - "5349:5349/udp"
    healthcheck:
      test: ["CMD", "nc", "-zu", "127.0.0.1", "3478"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - matrix-network

  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    volumes:
      - ./synapse:/data
    ports:
      - "8008:8008"
      - "8448:8448"
    environment:
      - TZ=${TZ:-UTC}
      - UID=${UID:-991}
      - GID=${GID:-991}
      - SYNAPSE_SERVER_NAME=${SYNAPSE_SERVER_NAME:-localhost}
      - SYNAPSE_REPORT_STATS=${SYNAPSE_REPORT_STATS:-yes}
      - SYNAPSE_VOIP_TURN_URIS=["turn:${TURN_SERVER:-localhost}:3478?transport=udp","turn:${TURN_SERVER:-localhost}:3478?transport=tcp","turns:${TURN_SERVER:-localhost}:5349?transport=udp","turns:${TURN_SERVER:-localhost}:5349?transport=tcp"]
      - SYNAPSE_VOIP_TURN_SHARED_SECRET=${TURN_SHARED_SECRET:-}
    healthcheck:
      test: ["CMD", "curl", "-fSs", "http://localhost:8008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      coturn:
        condition: service_healthy
    networks:
      - matrix-network

  element:
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ./element-config.json:/app/config.json
      - ./element-theme:/app/themes/samsesh
    ports:
      - "8080:80"
    environment:
      - MATRIX_THEMES=${MATRIX_THEMES:-light,dark}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      synapse:
        condition: service_healthy
    networks:
      - matrix-network

  synapse-admin:
    image: awesometechnologies/synapse-admin
    restart: unless-stopped
    ports:
      - "8081:80"
    environment:
      - REACT_APP_SERVER=http://synapse:8008
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      synapse:
        condition: service_healthy
    networks:
      - matrix-network

  element-call:
    image: ghcr.io/element-hq/element-call:latest
    restart: unless-stopped
    ports:
      - "8082:8080"
    volumes:
      - ./element-call-config.json:/app/config.json
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      synapse:
        condition: service_healthy
      lk-jwt-service:
        condition: service_healthy
    networks:
      - matrix-network

  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    command: --config /etc/livekit.yaml
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
      # WebRTC port range for media traffic
      - "${WEBRTC_PORT_START:-50000}-${WEBRTC_PORT_END:-60000}:${WEBRTC_PORT_START:-50000}-${WEBRTC_PORT_END:-60000}/udp"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7880/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - matrix-network

  lk-jwt-service:
    image: ghcr.io/element-hq/lk-jwt-service:latest
    restart: unless-stopped
    ports:
      - "8083:8080"
    environment:
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_KEY=${LIVEKIT_KEY:-devkey}
      - LIVEKIT_SECRET=${LIVEKIT_SECRET:-secret}
      - LIVEKIT_FULL_ACCESS_HOMESERVERS=${SYNAPSE_SERVER_NAME:-localhost}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      livekit:
        condition: service_healthy
    networks:
      - matrix-network

networks:
  matrix-network:
    name: matrix-network
    driver: bridge
